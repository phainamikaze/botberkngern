const sendApi = require('./send');
const Lists = require('./lists');

const sendOwnedLists = async (senderId, type) => {
  try{
    const lists1 = await Lists.getOwnedForUser(senderId);
    await sendApi.sendLists(senderId, type.substring(0, 11), lists1, Number(type.substring(19)));
    return;
  }catch(e){
    return;
  }
};

const sendSharedLists = async (senderId, type) => {
  try{
    const lists2 = await Lists.getSharedToUser(senderId);
    await sendApi.sendLists(senderId, type.substring(0, 16), lists2, Number(type.substring(22)));
    return;
  }catch(e){
    return;
  }
};

const handleReceivePostback =async (event) => {
  const type = event.postback.payload;
  const senderId = event.sender.id;

  if (type.substring(0, 11) === 'owned_lists') {
    await sendOwnedLists(senderId, type);
    return;
  } else if (type.substring(0, 16) === 'subscribed_lists') {
    await sendSharedLists(senderId, type);
    return;
  } else if (type.substring(0, 11) === 'GET_STARTED') {
    await sendApi.sendWelcomeMessage(senderId);
    return;
  }else{
    return;
  }

  // sendApi.sendMessage(senderId, `Unknown Postback called: ${type}`);
};

module.exports = {
  handleReceivePostback
};
