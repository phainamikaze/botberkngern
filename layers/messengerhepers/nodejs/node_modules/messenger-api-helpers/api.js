const castArray = require('lodash/castArray');
const isEmpty = require('lodash/isEmpty');
const request = require('request');
const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;

const callAPI = async (endPoint, messageDataArray, queryParams = {}, retries = 1) => {
  if (!endPoint) {
    console.error('callAPI requires you to specify an endpoint.');
    return;
  }

  if (!PAGE_ACCESS_TOKEN) {
    console.error('callAPI requires you to specify a page access token.');
    return;
  }

  if (retries < 0) {
    console.error(
      'No more retries left.',
      {endPoint, messageDataArray, queryParams}
    );
    return;
  }

  const query = Object.assign({access_token: PAGE_ACCESS_TOKEN}, queryParams);

  const [messageToSend, ...queue] = castArray(messageDataArray);
  try{
    await callRequest(endPoint,messageToSend,query);
    // continue sending payloads until queue empty
    if (!isEmpty(queue)) {
      await callAPI(endPoint, queue, queryParams);
    }
    return;
  }catch(e){
    // Retry the request
    console.error(`Retrying Request: ${retries} left`);
    await callAPI(endPoint, messageDataArray, queryParams, retries - 1);
    return;
  }
    
};

const callMessagesAPI = async (messageDataArray, queryParams = {}) => {
  await callAPI('messages', messageDataArray, queryParams);
  return;
};

const callMessengerProfileAPI = (messageDataArray, queryParams = {}) => {
  return callAPI('messenger_profile', messageDataArray, queryParams);
};

const callRequest = (endPoint,messageToSend,query) => {
  return new Promise((resolve,reject)=>{
    request({
      uri: `https://graph.facebook.com/v2.6/me/${endPoint}`,
      qs: query,
      method: 'POST',
      json: messageToSend,

    }, (error, response, body) => {
      if (!error && response.statusCode === 200) {
        // Message has been successfully received by Facebook
        console.log(
          `Successfully sent message to ${endPoint} endpoint: `,
          JSON.stringify(body)
        );
        resolve('OK');
      } else {
        // Message has not been successfully received by Facebook
        console.error(
          `Failed calling Messenger API endpoint ${endPoint}`,
          response.statusCode,
          response.statusMessage,
          body.error
        );
        reject('ERROR');
      }
    });
  });
};

module.exports = {
  callMessagesAPI,
  callMessengerProfileAPI,
};
